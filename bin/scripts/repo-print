#!/bin/bash
set -euo pipefail

# Usage: ./script.sh py ts js [--exclude pattern] [--exclude pattern2]

#git_root=$(git rev-parse --show-toplevel)
#cd "$git_root"

# Parse arguments
extensions=()
extra_excludes=()
parsing_excludes=false
while [ $# -gt 0 ]; do
    case "$1" in
        --exclude|-e)
            parsing_excludes=true
            shift
            ;;
        *)
            if $parsing_excludes; then
                extra_excludes+=("$1")
            else
                extensions+=("$1")
            fi
            shift
            ;;
    esac
done

echo "### Repo tree:"
git ls-files | tree --fromfile
echo

if [ ${#extensions[@]} -eq 0 ]; then
    echo "No file searches provided."
    exit 1
fi

pattern=$(printf "|%s" "${extensions[@]}")
pattern=${pattern:1}

# Files to exclude (lock files, generated files, etc.)
exclude_pattern="pnpm-lock\.yaml|package-lock\.json|yarn\.lock|go\.mod|go\.sum|Cargo\.lock|poetry\.lock|Gemfile\.lock|composer\.lock|\.min\.js|\.min\.css|dist/|build/|node_modules/|vendor/"

# Add extra excludes from command line
for ex in "${extra_excludes[@]+"${extra_excludes[@]}"}"; do
    exclude_pattern="$exclude_pattern|$ex"
done

matches=$(git ls-files | grep -E "$pattern" | grep -Ev "$exclude_pattern" || true)

if [ -z "$matches" ]; then
    echo "No files found with the specified search string: $*"
    exit 0
fi

while IFS= read -r file; do
    # Check MIME type, only include text/* files
    mime=$(file --mime-type -b "$file")
    if [[ "$mime" == text/* || "$mime" == application/json ]]; then
        echo -e "\n"
        echo -e "\n#########################"
        echo -e "### $file"
        cat "$file"
    else
        echo -e "\n### Skipping binary: $file (mime: $mime)"
    fi
done <<< "$matches"

echo -e "\n\n#########################"
echo -e "### Files listed above:"
echo "$matches" | while IFS= read -r file; do
    echo "- $file"
done

