#!/bin/bash
set -euo pipefail

# git diff wrapper with filtering options
# Usage: git-diff-filter <ref> [OPTIONS]

skip_above=""
only_additions=false
only_removals=false
excludes=()
ref=""

show_help() {
    cat <<EOF
Usage: gd <ref> [OPTIONS]

Arguments:
  ref                    Git ref to diff against (branch, commit, tag)

Options:
  -s, --skip-above N     Skip files with more than N lines changed
  -a, --only-additions   Only show added lines (+ lines)
  -r, --only-removals    Only show removed lines (- lines)
  -e, --exclude PATTERNS Exclude files matching PATTERNS (space-separated, must be last)
  -h, --help             Show this help message

Examples:
  gd main                 Diff against main
  gd main -s 2000         Skip files with >2000 lines changed
  gd HEAD~3 -a            Only show additions since 3 commits ago
  gd v1.0.0 -r            Only show removals since tag
  gd main -e test mock    Exclude files matching 'test' or 'mock'
EOF
    exit 0
}

# First arg should be the ref (unless it's -h)
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
fi

ref="$1"
shift

# Parse remaining arguments
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            show_help
            ;;
        -s|--skip-above)
            if [ $# -lt 2 ] || [[ "$2" == -* ]]; then
                echo "Error: -s requires a number"
                exit 1
            fi
            skip_above="$2"
            shift 2
            ;;
        -a|--only-additions)
            only_additions=true
            shift
            ;;
        -r|--only-removals)
            only_removals=true
            shift
            ;;
        -e|--exclude)
            shift
            while [ $# -gt 0 ] && [[ "$1" != -* ]]; do
                excludes+=("$1")
                shift
            done
            if [ ${#excludes[@]} -eq 0 ]; then
                echo "Error: -e requires at least one pattern"
                exit 1
            fi
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Build exclude pattern
exclude_pattern=""
for ex in "${excludes[@]+${excludes[@]}}"; do
    if [ -z "$exclude_pattern" ]; then
        exclude_pattern="$ex"
    else
        exclude_pattern="$exclude_pattern|$ex"
    fi
done

# Collect file stats
skip_files=()
included_files=()
file_stats=""
total_lines=0
included_lines=0

while IFS=$'\t' read -r adds dels file; do
    [ -z "$file" ] && continue

    # Handle binary files (shown as - -)
    if [ "$adds" = "-" ]; then
        adds=0
        dels=0
    fi

    total=$((adds + dels))
    total_lines=$((total_lines + total))

    skip_reason=""

    # Check exclude pattern
    if [ -n "$exclude_pattern" ] && echo "$file" | grep -Eq "$exclude_pattern"; then
        skip_reason="excluded"
        skip_files+=("$file")
    # Check line count
    elif [ -n "$skip_above" ] && [ "$total" -gt "$skip_above" ]; then
        skip_reason="too large"
        skip_files+=("$file")
    else
        included_files+=("$file")
        included_lines=$((included_lines + total))
    fi

    file_stats+="${total}:${adds}:${dels}:${skip_reason}:${file}"$'\n'
done < <(git diff --numstat "$ref")

# Build path exclusion args for git diff
path_args=()
for f in "${skip_files[@]+${skip_files[@]}}"; do
    path_args+=(":(exclude)$f")
done

if [ ${#included_files[@]} -eq 0 ]; then
    echo "No files to show (all filtered out)"
    exit 0
fi

diff_output=$(git diff "$ref" -- . "${path_args[@]+${path_args[@]}}")

if [ -z "$diff_output" ]; then
    echo "No changes"
    exit 0
fi

# Filter additions/removals if requested
if $only_additions; then
    echo "$diff_output" | grep -E '^(diff|index|---|\+\+\+|@@|[+]|[^-])' | grep -v '^--$'
elif $only_removals; then
    echo "$diff_output" | grep -E '^(diff|index|---|\+\+\+|@@|[-]|[^+])' | grep -v '^++$'
else
    echo "$diff_output"
fi

# Print summary to stderr at the end
{
    echo ""
    echo "### Files changed:"
    while IFS=':' read -r total adds dels reason file; do
        [ -z "$file" ] && continue
        if [ -n "$reason" ]; then
            printf "%6d  (+%-4d -%4d)  [%s] %s\n" "$total" "$adds" "$dels" "$reason" "$file"
        else
            printf "%6d  (+%-4d -%4d)  %s\n" "$total" "$adds" "$dels" "$file"
        fi
    done <<< "$(echo -n "$file_stats" | sort -t: -k1 -n)"
    echo "-----------------------------------"
    printf "Total: %d lines changed\n" "$total_lines"
    if [ ${#skip_files[@]} -gt 0 ]; then
        printf "Showing: %d lines (%d files), Skipped: %d lines (%d files)\n" \
            "$included_lines" "${#included_files[@]}" \
            "$((total_lines - included_lines))" "${#skip_files[@]}"
    fi
} >&2
