#!/bin/bash
set -eou pipefail

function detect_package_manager() {
  local target_dir="$1"
  local locks=$(git ls-files | grep -E "(bun\.lockb?|pnpm-lock\.yaml|yarn\.lock|package-lock\.json)$")

  [[ -z "$locks" ]] && echo "npm" && return

  local best_pm="npm"
  local best_depth=-1

  while IFS= read -r lock; do
    local lock_dir=$(dirname "$lock")
    [[ "$lock_dir" == "." ]] && lock_dir=""

    # Check if lock_dir is a prefix of target_dir (or same)
    if [[ "$target_dir" == "$lock_dir"* ]]; then
      local depth=${#lock_dir}
      if (( depth > best_depth )); then
        best_depth=$depth
        case "$lock" in
          *bun.lock*) best_pm="bun" ;;
          *pnpm-lock.yaml) best_pm="pnpm" ;;
          *yarn.lock) best_pm="yarn" ;;
          *package-lock.json) best_pm="npm" ;;
        esac
      fi
    fi
  done <<< "$locks"

  echo "$best_pm"
}

function npmf() {
  scripts=$(git ls-files |                                                        \
    grep "package.json" |                                                      \
    xargs jq -r '.scripts // {} | to_entries[] | input_filename + "|" + .key + "|" + .value' 2>/dev/null \
  )

  # Use fzf to select a script
  selected=$(echo "$scripts" | fzf --border --prompt="Select a script to run: ")

  # Exit if no selection was made
  if [ -z "$selected" ]; then
    echo "No script selected"
    exit 0
  fi

  # Parse the selected line: file|script_name|command
  file=$(echo "$selected" | cut -d'|' -f1)
  script_name=$(echo "$selected" | cut -d'|' -f2)
  command=$(echo "$selected" | cut -d'|' -f3-)

  # Extract the directory from the package.json path
  dir=$(dirname "$file")

  # Detect package manager from lock files
  pm=$(detect_package_manager "$dir")

  # Build the command
  cmd="cd \"$dir\" && $pm run \"$script_name\""

  # Show what we're running
  echo "Running '$script_name' from $file (using $pm)"
  echo "Command: $command"
  echo ""

  # Add to shell history (zsh or bash)
  if ! print -s "$cmd" &>/dev/null; then
    if ! history -s "$cmd" &>/dev/null; then
      : # silently fail if neither works
    fi
  fi

  # Change to the directory and run the script
  cd "$dir" && $pm run "$script_name"
}


npmf
