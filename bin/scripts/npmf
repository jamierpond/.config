#!/bin/bash
set -eou pipefail

function detect_package_manager() {
  local files=$(git ls-files)
  if echo "$files" | grep -q "bun.lock"; then
    echo "bun"
  elif echo "$files" | grep -q "pnpm-lock.yaml"; then
    echo "pnpm"
  elif echo "$files" | grep -q "yarn.lock"; then
    echo "yarn"
  else
    echo "npm"
  fi
}

function npmf() {
  scripts=$(git ls-files |                                                        \
    grep "package.json" |                                                      \
    xargs jq -r '.scripts // {} | to_entries[] | input_filename + "|" + .key + "|" + .value' 2>/dev/null \
  )

  # Use fzf to select a script
  selected=$(echo "$scripts" | fzf --border --prompt="Select a script to run: ")

  # Exit if no selection was made
  if [ -z "$selected" ]; then
    echo "No script selected"
    exit 0
  fi

  # Parse the selected line: file|script_name|command
  file=$(echo "$selected" | cut -d'|' -f1)
  script_name=$(echo "$selected" | cut -d'|' -f2)
  command=$(echo "$selected" | cut -d'|' -f3-)

  # Extract the directory from the package.json path
  dir=$(dirname "$file")

  # Detect package manager from lock files
  pm=$(detect_package_manager "$dir")

  # Build the command
  cmd="cd \"$dir\" && $pm run \"$script_name\""

  # Show what we're running
  echo "Running '$script_name' from $file (using $pm)"
  echo "Command: $command"
  echo ""

  # Add to shell history (zsh or bash)
  if ! print -s "$cmd" &>/dev/null; then
    if ! history -s "$cmd" &>/dev/null; then
      : # silently fail if neither works
    fi
  fi

  # Change to the directory and run the script
  cd "$dir" && $pm run "$script_name"
}


npmf
