#!/usr/bin/env bash
set -euo pipefail

# Ensure package managers are in PATH (needed when run from tmux)
# Nix, ARM64 Mac homebrew, Intel Mac homebrew
export PATH="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/opt/homebrew/bin:/usr/local/bin:$PATH"

CONFIG="$HOME/.config/bin/scripts/quick-urls.yaml"

[[ ! -f "$CONFIG" ]] && echo "Config not found: $CONFIG" && exit 1

# Generate all URLs from YAML config
generate_urls() {
  # Static URLs
  yq -r '.static[] | (.name // .url) + "|" + .url' "$CONFIG" 2>/dev/null

  # GCloud URLs
  local gcloud_projects=$(yq -r '.gcloud.projects[]' "$CONFIG" 2>/dev/null)
  local gcloud_services=$(yq -r '.gcloud.services[]' "$CONFIG" 2>/dev/null)
  for project in $gcloud_projects; do
    for service in $gcloud_services; do
      echo "${project} ${service}|https://console.cloud.google.com/${service}?project=${project}"
    done
  done

  # Firebase URLs
  local firebase_services=$(yq -r '.firebase.services[]' "$CONFIG" 2>/dev/null)
  for project in $gcloud_projects; do
    echo "${project} Firebase|https://console.cloud.google.com/welcome?project=${project}"
    for service in $firebase_services; do
      echo "${project} ${service}|https://console.firebase.google.com/u/0/project/${project}/${service}"
    done
  done

  # GitHub URLs
  local github_repos=$(yq -r '.github.repos[]' "$CONFIG" 2>/dev/null)
  for repo in $github_repos; do
    echo "${repo}|https://github.com/${repo}"
    echo "${repo} pulls|https://github.com/${repo}/pulls"
    echo "${repo} actions|https://github.com/${repo}/actions"
  done

  # Emulator URLs
  local emulator_base=$(yq -r '.emulator.base_url' "$CONFIG" 2>/dev/null)
  if [[ -n "$emulator_base" && "$emulator_base" != "null" ]]; then
    echo "Local Emulator|${emulator_base}"
    for service in $firebase_services; do
      echo "Local ${service}|${emulator_base}/${service}"
    done
  fi
}

# Generate and cache URLs
all_urls=$(generate_urls)

# Format for display: NAME | URL (truncated)
display=$(echo "$all_urls" | awk -F'|' '{
  name = substr($1, 1, 45)
  url = substr($2, 1, 65)
  printf "%-45s  %s\n", name, url
}')

# Use fzf with line numbers to track selection
selected_num=$(echo "$display" | nl -ba | \
  fzf --border --prompt="Open URL: " \
      --header="NAME                                           URL" \
      --with-nth=2.. | \
  awk '{print $1}')

[[ -z "$selected_num" ]] && exit 0

# Get raw line by number and extract URL
selected_url=$(echo "$all_urls" | sed -n "${selected_num}p" | cut -d'|' -f2)

if [[ -n "$selected_url" ]]; then
  echo "Opening: ${selected_url}"
  if [[ "$(uname)" == "Darwin" ]]; then
    open "$selected_url"
  else
    ~/.config/bin/scripts/do-on-mac "open ${selected_url}"
  fi
fi
