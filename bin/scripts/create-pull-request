#!/bin/bash
set -e

current_branch=$(git branch --show-current)

echo "Current branch: $current_branch"

existing_pr=$(gh pr list --state open --head "$current_branch")

function openweb() {
  if [ $(uname) == "Darwin" ]; then
    gh pr view --web
  else
    "$HOME/.config/bin/scripts/do-on-mac" "open $(gh pr view --json url | jq '.url')"
  fi
}

if [ -n "$existing_pr" ]; then
  echo "PR already exists: $existing_pr"
  openweb
  exit 0
fi

git_root=$(git rev-parse --show-toplevel)
pond_yml="$git_root/.pond.yml"
base_branch=""

if [ -f "$pond_yml" ]; then
  base_branch=$(yq -r '.pr_base_branch // ""' "$pond_yml")
fi

export EDITOR="nvim"
if [ -n "$base_branch" ]; then
  gh pr create --base "$base_branch"
else
  gh pr create
fi
openweb


