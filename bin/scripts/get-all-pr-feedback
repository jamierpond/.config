#!/usr/bin/env bash
set -euo pipefail

# PR feedback dumper - outputs human/LLM friendly text
# Usage: get-all-pr-feedback

if ! command -v jq >/dev/null 2>&1; then
  echo "jq is required" >&2
  exit 1
fi

repo=$(gh repo view --json nameWithOwner -q '.nameWithOwner')

pr_number=$(gh pr list --head "$(git rev-parse --abbrev-ref HEAD)" --state all \
  --json number -q '.[0].number')

if [[ -z "${pr_number:-}" || "${pr_number}" == "null" ]]; then
  echo "No PR found for this branch in $repo" >&2
  exit 1
fi

pr_title=$(gh pr view "$pr_number" --json title -q '.title')
echo "# PR #${pr_number}: ${pr_title}"
echo

# Issue comments
comments=$(gh api "repos/${repo}/issues/${pr_number}/comments" --paginate)
if [[ $(echo "$comments" | jq 'length') -gt 0 ]]; then
  echo "## Comments"
  echo
  echo "$comments" | jq -r '.[] | "### \(.user.login)\n\(.body)\n"'
fi

# Reviews (with body)
reviews=$(gh api "repos/${repo}/pulls/${pr_number}/reviews" --paginate)
if [[ $(echo "$reviews" | jq '[.[] | select(.body != "")] | length') -gt 0 ]]; then
  echo "## Reviews"
  echo
  echo "$reviews" | jq -r '.[] | select(.body != "") | "### \(.user.login) (\(.state))\n\(.body)\n"'
fi

# Inline review comments
inline=$(gh api "repos/${repo}/pulls/${pr_number}/comments" --paginate)
if [[ $(echo "$inline" | jq 'length') -gt 0 ]]; then
  echo "## Inline Comments"
  echo
  echo "$inline" | jq -r '.[] | "### \(.user.login) on \(.path)\n\(.body)\n"'
fi

