#!/usr/bin/env python3
"""Browse and restore files from Cloudflare R2 using fzf."""

import subprocess
import sys
import os
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
CONFIG_FILE = SCRIPT_DIR / "r2.conf"
BUCKET = "jamie-personal"
REMOTE = "r2-backup"

def rclone(*args):
    """Run rclone command and return output."""
    cmd = ["rclone", "--config", str(CONFIG_FILE)] + list(args)
    result = subprocess.run(cmd, capture_output=True, text=True)
    return result.stdout, result.returncode

def list_files(path):
    """List all files at path."""
    out, _ = rclone("ls", path)
    files = []
    for line in out.strip().split("\n"):
        if line.strip():
            parts = line.split(maxsplit=1)
            if len(parts) == 2:
                files.append(parts[1])
    return files

def human_size(bytes_val):
    for unit in ['B', 'K', 'M', 'G', 'T']:
        if bytes_val < 1024:
            return f"{bytes_val:.1f}{unit}"
        bytes_val /= 1024
    return f"{bytes_val:.1f}P"

def main():
    import argparse
    parser = argparse.ArgumentParser(description="Browse and restore files from R2")
    parser.add_argument("path", nargs="?", default="", help="Path to browse in bucket")
    parser.add_argument("-o", "--output", help="Restore destination")
    parser.add_argument("-l", "--list", action="store_true", help="List files without fzf")
    parser.add_argument("-b", "--bucket", default=BUCKET, help=f"Bucket name (default: {BUCKET})")
    args = parser.parse_args()

    bucket = args.bucket
    browse_path = args.path.strip("/") if args.path else ""
    remote_base = f"{REMOTE}:{bucket}"
    remote_path = f"{remote_base}/{browse_path}" if browse_path else remote_base

    if not CONFIG_FILE.exists():
        print(f"Error: Config not found: {CONFIG_FILE}")
        sys.exit(1)

    # Check fzf for interactive mode
    if not args.list:
        if subprocess.run(["which", "fzf"], capture_output=True).returncode != 0:
            print("Error: fzf not installed. Run: brew install fzf")
            print("Or use -l for list mode")
            sys.exit(1)

    print(f"Loading files from: {remote_path}")
    files = list_files(remote_path)

    if not files:
        print("No files found.")
        sys.exit(0)

    print(f"Found {len(files)} files")

    # List mode
    if args.list:
        for f in files:
            print(f"  {f}")
        sys.exit(0)

    # fzf selection
    proc = subprocess.run(
        ["fzf", "--multi",
         "--prompt=Select files (TAB=multi) > ",
         f"--header=Browsing: {remote_path}",
         "--bind=ctrl-a:select-all"],
        input="\n".join(files),
        capture_output=True, text=True
    )

    if proc.returncode != 0 or not proc.stdout.strip():
        print("No files selected.")
        sys.exit(0)

    selected = proc.stdout.strip().split("\n")
    print()
    print("=" * 50)
    print(f"Selected {len(selected)} file(s):")
    print("=" * 50)
    for f in selected[:10]:
        print(f"  {f}")
    if len(selected) > 10:
        print(f"  ... and {len(selected) - 10} more")

    # Determine restore location
    if args.output:
        restore_base = Path(args.output).expanduser()
    else:
        # Try to restore to original location based on first path component
        first_file = selected[0]
        first_dir = first_file.split("/")[0] if "/" in first_file else ""
        if first_dir in ["Downloads", "Documents", "Photos", "Movies", "Music", "Desktop"]:
            restore_base = Path.home()
        else:
            restore_base = Path.home() / "restored-from-r2"

    print()
    print(f"Restore to: {restore_base}")
    if browse_path:
        print(f"Path prefix: {browse_path}")

    answer = input("\nContinue? (y/n): ").strip().lower()
    if answer != 'y':
        print("Aborted.")
        sys.exit(0)

    # Restore files
    print()
    for f in selected:
        if browse_path:
            src = f"{remote_base}/{browse_path}/{f}"
            dst = restore_base / browse_path / f
        else:
            src = f"{remote_base}/{f}"
            dst = restore_base / f

        print(f"Restoring: {f}")
        dst.parent.mkdir(parents=True, exist_ok=True)
        subprocess.run([
            "rclone", "copyto", src, str(dst),
            "--config", str(CONFIG_FILE),
            "--progress"
        ])

    print()
    print("=" * 50)
    print(f"Restore complete! Files in: {restore_base}")
    print("=" * 50)

if __name__ == "__main__":
    main()
