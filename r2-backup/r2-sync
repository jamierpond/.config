#!/usr/bin/env python3
"""Sync local directories to Cloudflare R2 bucket."""

import subprocess
import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
CONFIG_FILE = SCRIPT_DIR / "r2.conf"
REMOTE = "r2-backup"

DEFAULT_DIRS = [
    Path.home() / "Downloads",
    Path.home() / "Documents",
    Path.home() / "Photos",
    Path.home() / "Movies",
    Path.home() / "Music",
    Path.home() / "Desktop",
]

def human_size(bytes_val):
    for unit in ['B', 'K', 'M', 'G', 'T']:
        if bytes_val < 1024:
            return f"{bytes_val:.1f}{unit}"
        bytes_val /= 1024
    return f"{bytes_val:.1f}P"

def get_dir_size(path):
    if not path.exists():
        return 0
    try:
        result = subprocess.run(["du", "-sk", str(path)], capture_output=True, text=True)
        return int(result.stdout.split()[0]) * 1024
    except:
        return 0

def sync_directory(dir_path, bucket, dry_run=False, delete=False):
    if not dir_path.exists():
        print(f"  Skipping (not found): {dir_path}")
        return False

    dir_name = dir_path.name
    remote_path = f"{REMOTE}:{bucket}/{dir_name}"

    print()
    print("=" * 50)
    print(f"Syncing: {dir_path}")
    print(f"     To: {remote_path}")
    if dry_run:
        print("[DRY RUN]")
    print("=" * 50)

    cmd = [
        "rclone", "sync",
        str(dir_path), remote_path,
        "--config", str(CONFIG_FILE),
        "--progress",
        "--stats-one-line",
        "--stats=5s",
        "--stats-file-name-length=40",
        "--log-level", "INFO",
    ]

    if dry_run:
        cmd.append("--dry-run")
    if delete:
        cmd.append("--delete-during")

    subprocess.run(cmd)
    print(f"Done: {dir_name}")
    return True

def select_with_fzf(options):
    try:
        proc = subprocess.run(
            ["fzf", "--multi", "--prompt=Select dirs > "],
            input="\n".join(str(o) for o in options),
            capture_output=True, text=True
        )
        if proc.returncode == 0 and proc.stdout.strip():
            return [Path(p) for p in proc.stdout.strip().split("\n")]
    except FileNotFoundError:
        pass
    return None

def main():
    import argparse

    default_bucket = "jamie-personal"

    parser = argparse.ArgumentParser(description="Sync directories to Cloudflare R2")
    parser.add_argument("dirs", nargs="*", help="Directories to sync")
    parser.add_argument("-n", "--dry-run", action="store_true",
                        help="Show what would be transferred (defaults to all dirs if none specified)")
    parser.add_argument("-d", "--delete", action="store_true",
                        help="Delete files in R2 that don't exist locally")
    parser.add_argument("-a", "--all", action="store_true",
                        help="Sync all default directories")
    parser.add_argument("-l", "--list", action="store_true",
                        help="List default directories")
    parser.add_argument("-b", "--bucket", default=default_bucket,
                        help=f"R2 bucket name (default: {default_bucket})")
    args = parser.parse_args()

    bucket = args.bucket

    # Check rclone
    if subprocess.run(["which", "rclone"], capture_output=True).returncode != 0:
        print("Error: rclone not installed. Run: brew install rclone")
        sys.exit(1)

    if not CONFIG_FILE.exists():
        print(f"Error: Config not found: {CONFIG_FILE}")
        sys.exit(1)

    # List mode
    if args.list:
        print("Default directories:")
        for d in DEFAULT_DIRS:
            status = "exists" if d.exists() else "missing"
            print(f"  [{status}] {d}")
        sys.exit(0)

    # Determine directories
    if args.dirs:
        dirs = [Path(d).expanduser().resolve() for d in args.dirs]
    elif args.all or args.dry_run:
        dirs = DEFAULT_DIRS
    else:
        dirs = select_with_fzf(DEFAULT_DIRS)
        if not dirs:
            print("No directories specified. Use -a for all, or specify paths.")
            print()
            for d in DEFAULT_DIRS:
                status = "exists" if d.exists() else "missing"
                print(f"  [{status}] {d}")
            sys.exit(1)

    # Calculate sizes and show summary
    print()
    print("=" * 50)
    print("R2 Backup Sync")
    print("=" * 50)
    print()
    print("Directories:")

    total_bytes = 0
    for d in dirs:
        size = get_dir_size(d)
        total_bytes += size
        status = human_size(size) if d.exists() else "[not found]"
        print(f"  {str(d):<40} {status:>10}")

    print()
    print("-" * 50)
    print(f"  {'Bucket:':<12} {bucket}")
    print(f"  {'Total:':<12} {human_size(total_bytes)}")
    if args.dry_run:
        print(f"  {'Mode:':<12} DRY RUN (no changes)")
    if args.delete:
        print(f"  {'Delete:':<12} YES (removed files deleted from R2)")
    print("=" * 50)
    print()

    # Confirm
    answer = input("Continue? (y/n): ").strip().lower()
    if answer != 'y':
        print("Aborted.")
        sys.exit(0)

    # Sync
    for d in dirs:
        sync_directory(d, bucket, dry_run=args.dry_run, delete=args.delete)

    print()
    print("=" * 50)
    print("All syncs complete!")
    print("=" * 50)

if __name__ == "__main__":
    main()
